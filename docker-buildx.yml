# Docker Buildx configuration for multi-architecture and multi-region builds
# This configuration supports building for multiple platforms simultaneously

name: photonic-foundry-global-build

# Define build contexts for different regions
contexts:
  global:
    dockerfile: Dockerfile.multi-region
    context: .
  
  us-east-1:
    dockerfile: Dockerfile.multi-region
    context: .
    args:
      REGION: us-east-1
  
  eu-west-1:
    dockerfile: Dockerfile.multi-region
    context: .
    args:
      REGION: eu-west-1
  
  ap-southeast-1:
    dockerfile: Dockerfile.multi-region
    context: .
    args:
      REGION: ap-southeast-1

# Multi-platform targets
platforms:
  - linux/amd64
  - linux/arm64
  - linux/arm/v7
  - linux/riscv64  # For quantum compute platforms

# Build configurations
builds:
  global:
    platforms:
      - linux/amd64
      - linux/arm64
    tags:
      - photonic-foundry:latest
      - photonic-foundry:1.0.0
      - photonic-foundry:global-latest
    cache:
      from:
        - type=gha,scope=global-build
      to:
        - type=gha,scope=global-build,mode=max
    
  us-east-1:
    platforms:
      - linux/amd64  # Primarily AMD64 for high-performance computing
    tags:
      - photonic-foundry:us-east-1-latest
      - photonic-foundry:1.0.0-us-east-1
      - photonic-foundry:ccpa-compliant
    build-args:
      REGION: us-east-1
      COMPLIANCE_FRAMEWORK: ccpa
      GPU_SUPPORT: nvidia-a100
    cache:
      from:
        - type=gha,scope=us-east-1-build
      to:
        - type=gha,scope=us-east-1-build,mode=max
  
  eu-west-1:
    platforms:
      - linux/amd64
      - linux/arm64
    tags:
      - photonic-foundry:eu-west-1-latest
      - photonic-foundry:1.0.0-eu-west-1
      - photonic-foundry:gdpr-compliant
    build-args:
      REGION: eu-west-1
      COMPLIANCE_FRAMEWORK: gdpr
      GPU_SUPPORT: nvidia-h100
    cache:
      from:
        - type=gha,scope=eu-west-1-build
      to:
        - type=gha,scope=eu-west-1-build,mode=max
  
  ap-southeast-1:
    platforms:
      - linux/arm64  # ARM64 for edge computing optimization
      - linux/amd64
    tags:
      - photonic-foundry:ap-southeast-1-latest
      - photonic-foundry:1.0.0-ap-southeast-1
      - photonic-foundry:pdpa-compliant
    build-args:
      REGION: ap-southeast-1
      COMPLIANCE_FRAMEWORK: pdpa
      EDGE_OPTIMIZED: true
    cache:
      from:
        - type=gha,scope=ap-southeast-1-build
      to:
        - type=gha,scope=ap-southeast-1-build,mode=max
  
  quantum-compute:
    platforms:
      - linux/riscv64
      - linux/amd64
    tags:
      - photonic-foundry:quantum-compute-latest
      - photonic-foundry:1.0.0-quantum
    build-args:
      QUANTUM_OPTIMIZED: true
      QUANTUM_ARCHITECTURE: risc-v
    cache:
      from:
        - type=gha,scope=quantum-build
      to:
        - type=gha,scope=quantum-build,mode=max

# Output configurations
outputs:
  registry:
    type: registry
    push: true
  
  local:
    type: local
    dest: ./build-output
  
  oci:
    type: oci
    dest: ./oci-images

# Advanced build features
features:
  multi-platform: true
  buildkit-inline-cache: true
  buildkit-remote-cache: true
  security-scanning: true
  sbom-generation: true
  attestation: true

# Registry configurations for different regions
registries:
  global:
    registry: docker.io/photonicfoundry
    username: ${DOCKER_USERNAME}
    password: ${DOCKER_PASSWORD}
  
  us-east-1:
    registry: ${AWS_ACCOUNT_ID}.dkr.ecr.us-east-1.amazonaws.com/photonic-foundry
    username: AWS
    password: ${AWS_ECR_TOKEN}
  
  eu-west-1:
    registry: ${AWS_ACCOUNT_ID}.dkr.ecr.eu-west-1.amazonaws.com/photonic-foundry
    username: AWS
    password: ${AWS_ECR_TOKEN}
  
  ap-southeast-1:
    registry: ${AWS_ACCOUNT_ID}.dkr.ecr.ap-southeast-1.amazonaws.com/photonic-foundry
    username: AWS
    password: ${AWS_ECR_TOKEN}

# Build optimization
optimization:
  layer-caching: true
  parallel-builds: true
  build-arg-inheritance: true
  context-sharing: true
  
# Security scanning
security:
  vulnerability-scanning: true
  secret-scanning: true
  policy-enforcement: true
  compliance-validation: true
  
# Performance optimization
performance:
  build-concurrency: 4
  memory-limit: 8g
  cpu-limit: 4
  timeout: 3600s  # 1 hour timeout